name: CI/CD Pipeline to EC2

on:
  push:
    branches: [main] # –ó–∞–ø—É—Å–∫–∞—Ç—å –ø—Ä–∏ –ø—É—à–µ –≤ –≤–µ—Ç–∫—É main

jobs:
  deploy:
    runs-on: ubuntu-latest


    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0 # –ü–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –¥–ª—è Git Submodules, –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è

    - name: Set up SSH
      uses: webfactory/ssh-agent@v0.5.3 # –ë–æ–ª–µ–µ —É–¥–æ–±–Ω—ã–π —Å–ø–æ—Å–æ–± –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ SSH
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

    - name: Deploy to Server via SSH
      env:
        SSH_HOST: ${{ secrets.SSH_HOST }}
        SSH_USERNAME: ${{ secrets.SSH_USERNAME }}
        # –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –ø—É–±–ª–∏—á–Ω—ã–π URL –≤–∞—à–µ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è,
        # –µ—Å–ª–∏ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –ø—Ä–∏–≤–∞—Ç–Ω—ã–π, –Ω—É–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å SSH-–¥–æ—Å—Ç—É–ø –¥–ª—è Git
        REPO_REMOTE_URL: "https://github.com/zhenyapetko/portfolio-site.git" 

      run: |
        set -e # –í—ã–π—Ç–∏ –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ, –µ—Å–ª–∏ –ª—é–±–∞—è –∫–æ–º–∞–Ω–¥–∞ –∑–∞–≤–µ—Ä—à–∏—Ç—Å—è –Ω–µ—É–¥–∞—á–µ–π

        echo "Connecting to ${{ env.SSH_USERNAME }}@${{ env.SSH_HOST }}"

        # –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ heredoc (EOF) –¥–ª—è –±–æ–ª–µ–µ —á–∏—Å—Ç–æ–π –ø–µ—Ä–µ–¥–∞—á–∏ –º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞
        # –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –∏–∑–±–µ–∂–∞—Ç—å –ø—Ä–æ–±–ª–µ–º —Å —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º –∏ –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
        ssh -o StrictHostKeyChecking=no ${{ env.SSH_USERNAME }}@${{ env.SSH_HOST }} << 'EOF_SSH_SCRIPT'
          set -e # –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø–æ–≤—Ç–æ—Ä—è–µ–º set -e –≤–Ω—É—Ç—Ä–∏ —Å–∫—Ä–∏–ø—Ç–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
          
          REPO_PATH="/opt/portfolio-site" # –ü—É—Ç—å, –≥–¥–µ Docker Compose –ø—Ä–æ–µ–∫—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
          
          # –£–ë–ï–î–ò–¢–¨–°–Ø, –ß–¢–û –ú–ï–°–¢–û –ï–°–¢–¨
          echo "Performing Docker system prune..."
          docker system prune -f
          docker builder prune -f
          docker volume prune -f
          
          # --- –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è ---
          if [ ! -d "$REPO_PATH" ]; then
            echo "Cloning repository to $REPO_PATH..."
            git clone "$REPO_REMOTE_URL" "$REPO_PATH" || { echo "Failed to clone repository"; exit 1; }
          fi
          
          echo "Entering project directory: $REPO_PATH"
          cd "$REPO_PATH" || { echo "Failed to change directory to $REPO_PATH"; exit 1; }

          echo "Pulling latest changes from Git..."
          git pull origin main || { echo "Failed to pull latest changes"; exit 1; }
          
          # --- Docker Compose –¥–µ–π—Å—Ç–≤–∏—è ---
          echo "Stopping existing services..."
          docker-compose down || echo "No running services to stop or failed gracefully."
          
          echo "Building services..."
          docker-compose build --no-cache || { echo "Failed to build Docker images"; exit 1; }
          
          echo "Starting services..."
          docker-compose up -d --force-recreate || { echo "Failed to start Docker Compose services"; exit 1; }
          
          echo "Deployment successful."
        EOF_SSH_SCRIPT

    # --- Telegram-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Ç–µ–ø–µ—Ä—å –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω—ã–µ —à–∞–≥–∏, –∫–∞–∫ –∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å ---
    - name: Send Telegram Notification (Success)
      if: success()
      uses: appleboy/telegram-action@master
      with:
        to: ${{ secrets.TG_CHAT_ID }}
        token: ${{ secrets.TG_BOT_TOKEN }}
        format: markdown # –£–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º–∞—Ç Markdown
        message: |
          ‚ú® *Deployment Successful!* ‚ú®
          
          ---
          
          üöÄ *–ü—Ä–æ–µ–∫—Ç:* `{{ github.repository }}`
          üåø *–í–µ—Ç–∫–∞:* `{{ github.ref_name }}`
          üì¶ *–ö–æ–º–º–∏—Ç:* `{{ github.sha }}`
          
          ---
          
          üåê *–í–∞—à —Å–∞–π—Ç –¥–æ—Å—Ç—É–ø–µ–Ω:*
          [–ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ —Å–∞–π—Ç](http://${{ secrets.SSH_HOST }})
          
          üìä *–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ Grafana:*
          [Grafana Dashboard](http://${{ secrets.SSH_HOST }}:3000)
          
          üìà *–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ Prometheus:*
          [Prometheus Status](http://${{ secrets.SSH_HOST }}:9090)
          
          ---
          
          ‚úÖ *–í—Å–µ —Å–µ—Ä–≤–∏—Å—ã –∑–∞–ø—É—â–µ–Ω—ã –∏ —Ä–∞–±–æ—Ç–∞—é—Ç!*
    
    - name: Send Telegram Notification (Failure)
      if: failure()
      uses: appleboy/telegram-action@master
      with:
        to: ${{ secrets.TG_CHAT_ID }}
        token: ${{ secrets.TG_BOT_TOKEN }}
        format: markdown # –¢–∞–∫–∂–µ —É–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º–∞—Ç Markdown –¥–ª—è –æ—à–∏–±–æ–∫
        message: |
          üö® *Deployment Failed!* üö®
          
          ---
          
          ‚ùå *–ü—Ä–æ–µ–∫—Ç:* `{{ github.repository }}`
          üåø *–í–µ—Ç–∫–∞:* `{{ github.ref_name }}`
          üì¶ *–ö–æ–º–º–∏—Ç:* `{{ github.sha }}`
          
          ---
          
          üßê *–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏:*
          [GitHub Actions Logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          
          ---
          
          ‚ö†Ô∏è *–í–æ–∑–Ω–∏–∫–ª–∞ –æ—à–∏–±–∫–∞ –≤–æ –≤—Ä–µ–º—è –¥–µ–ø–ª–æ—è. –°—Ä–æ—á–Ω–æ –ø—Ä–∏–º–∏—Ç–µ –º–µ—Ä—ã!*