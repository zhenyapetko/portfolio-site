name: CI/CD Pipeline to EC2

on:
  push:
    branches: [main] # Запускать при пуше в ветку main

jobs:
  deploy:
    runs-on: ubuntu-latest


    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0 # Полная история для Git Submodules, если используются

    - name: Set up SSH
      uses: webfactory/ssh-agent@v0.5.3 # Более удобный способ настройки SSH
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

    - name: Deploy to Server via SSH
      env:
        SSH_HOST: ${{ secrets.SSH_HOST }}
        SSH_USERNAME: ${{ secrets.SSH_USERNAME }}
        REPO_REMOTE_URL: "https://github.com/zhenyapetko/portfolio-site.git" # Замените на публичный URL вашего репозитория

      run: |
        set -e # Выйти немедленно, если любая команда завершится неудачей

        echo "Connecting to ${{ env.SSH_USERNAME }}@${{ env.SSH_HOST }}"

        # Оборачиваем все команды для SSH в одну переменную.
        # Это позволяет избежать проблем с отступами heredoc внутри YAML.
        SSH_COMMANDS=$(cat << 'END_OF_COMMANDS'
          # Все команды, которые должны быть выполнены на удаленном сервере.
          # Здесь отступы НЕ ВАЖНЫ, потому что они внутри строки!
          REPO_PATH="/opt/portfolio-site" # Путь, где Docker Compose проект на сервере
          
          # --- Подготовка репозитория ---
          if [ ! -d "$REPO_PATH" ]; then
            echo "Cloning repository to $REPO_PATH..."
            git clone "$REPO_REMOTE_URL" "$REPO_PATH" || { echo "Failed to clone repository"; exit 1; }
          fi
          
          echo "Entering project directory: $REPO_PATH"
          cd "$REPO_PATH" || { echo "Failed to change directory to $REPO_PATH"; exit 1; }

          echo "Pulling latest changes from Git..."
          git pull origin main || { echo "Failed to pull latest changes"; exit 1; }
          
          # --- Docker Compose действия ---
          echo "Stopping existing services..."
          docker-compose down || echo "No running services to stop or failed gracefully."
          
          echo "Building services..."
          docker-compose build --no-cache || { echo "Failed to build Docker images"; exit 1; }
          
          echo "Starting services..."
          docker-compose up -d --force-recreate || { echo "Failed to start Docker Compose services"; exit 1; }
          
          echo "Deployment successful."
END_OF_COMMANDS
        ) # Закрытие переменной

        # Теперь выполняем SSH, передавая команды из переменной через stdin
        ssh -o StrictHostKeyChecking=no ${{ env.SSH_USERNAME }}@${{ env.SSH_HOST }} "${SSH_COMMANDS}"

    - name: Send Telegram Notification (Success)
      if: success() 
      uses: appleboy/telegram-action@master
      with:
        to: ${{ secrets.TG_CHAT_ID }}
        token: ${{ secrets.TG_BOT_TOKEN }}
        message: |
          ✅ Deployment Successful!
          Repository: ${{ github.repository }}
          Branch: ${{ github.ref_name }}
          Commit: ${{ github.sha }}
          View on EC2: http://${{ secrets.SSH_HOST }} (use your actual URL if custom domain)

    - name: Send Telegram Notification (Failure)
      if: failure() # Выполнить только если какой-либо предыдущий шаг провалился
      uses: appleboy/telegram-action@master
      with:
        to: ${{ secrets.TG_CHAT_ID }}
        token: ${{ secrets.TG_BOT_TOKEN }}
        message: |
          ❌ Deployment Failed!
          Repository: ${{ github.repository }}
          Branch: ${{ github.ref_name }}
          Commit: ${{ github.sha }}
          Logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          Please check the GitHub Actions logs for details.